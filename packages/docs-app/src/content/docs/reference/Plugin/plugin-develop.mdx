---
sidebar:
  order: 1
title: æ’ä»¶å¼€å‘æŒ‡å—
---

# æ’ä»¶å¼€å‘æŒ‡å—

Chameleon Engine é‡‡ç”¨æ’ä»¶åŒ–æ¶æ„ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥é€šè¿‡æ’ä»¶æ‰©å±•ã€‚æœ¬æ–‡æ¡£å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å¼€å‘è‡ªå®šä¹‰æ’ä»¶ã€‚

## æ’ä»¶æ¶æ„æ€»è§ˆ

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px', 'fontFamily':'Arial'}}}%%
graph TB
    subgraph Engine["Chameleon Engine"]
        direction TB

        subgraph CoreAPI["æ ¸å¿ƒ API å±‚"]
            direction LR
            CPage["CPage<br/><small>é¡µé¢æ¨¡å‹</small>"]
            Workbench["Workbench<br/><small>å·¥ä½œå°</small>"]
            EventBus["Event Emitter<br/><small>äº‹ä»¶æ€»çº¿</small>"]
            Assets["Assets Manager<br/><small>èµ„æºç®¡ç†</small>"]
            I18n["I18n<br/><small>å›½é™…åŒ–</small>"]
        end

        subgraph PluginSystem["æ’ä»¶ç³»ç»Ÿæ¶æ„"]
            direction TB

            subgraph Manager["PluginManager - æ’ä»¶ç®¡ç†å™¨"]
                direction TB

                subgraph Lifecycle["ç”Ÿå‘½å‘¨æœŸç®¡ç†"]
                    direction LR
                    Add["add()<br/><small>æ³¨å†Œæ’ä»¶</small>"]
                    Init["init()<br/><small>åˆå§‹åŒ–</small>"]
                    Ready["onPluginReadyOk()<br/><small>å°±ç»ªé€šçŸ¥</small>"]
                    Remove["remove()<br/><small>å¸è½½æ’ä»¶</small>"]
                end

                subgraph Extension["æ‰©å±•èƒ½åŠ›"]
                    direction LR
                    Get["get()<br/><small>è·å–æ’ä»¶</small>"]
                    Custom["customPlugin()<br/><small>å®šåˆ¶æ’ä»¶</small>"]
                    Export["export<br/><small>API å¯¼å‡º</small>"]
                end

                subgraph Context["æ’ä»¶ä¸Šä¸‹æ–‡ (CPluginCtx)"]
                    direction LR
                    CtxEmitter["äº‹ä»¶ç³»ç»Ÿ"]
                    CtxConfig["é…ç½®å¯¹è±¡"]
                    CtxAPI["æ ¸å¿ƒ API"]
                end
            end

            subgraph PluginLayer["æ’ä»¶å®ä¾‹å±‚ - å¯æ‰©å±•/å¯æ›¿æ¢"]
                direction TB

                subgraph BuiltIn["å†…ç½®æ’ä»¶"]
                    Designer["Designer"]
                    History["History"]
                    RightPanel["RightPanel"]
                    Others["..."]
                end

                subgraph Custom["è‡ªå®šä¹‰æ’ä»¶"]
                    CustomA["Custom Plugin A"]
                    CustomB["Custom Plugin B"]
                    CustomC["..."]
                end
            end
        end
    end

    style Engine fill:#f8f9fa,stroke:#212529,stroke-width:3px
    style CoreAPI fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style PluginSystem fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style Manager fill:#ede7f6,stroke:#5e35b1,stroke-width:2px
    style Lifecycle fill:#fff3e0,stroke:#ef6c00,stroke-width:1.5px
    style Extension fill:#e0f2f1,stroke:#00796b,stroke-width:1.5px
    style Context fill:#fce4ec,stroke:#c2185b,stroke-width:1.5px
    style PluginLayer fill:#e8eaf6,stroke:#3f51b5,stroke-width:1.5px
    style BuiltIn fill:#e8f5e9,stroke:#2e7d32,stroke-width:1px
    style Custom fill:#fff9c4,stroke:#f57f17,stroke-width:1px

    style CPage fill:#bbdefb,stroke:#1976d2
    style Workbench fill:#bbdefb,stroke:#1976d2
    style EventBus fill:#bbdefb,stroke:#1976d2
    style Assets fill:#bbdefb,stroke:#1976d2
    style I18n fill:#bbdefb,stroke:#1976d2
```

### æ¶æ„è¯´æ˜

ä¸Šå›¾å±•ç¤ºäº† Chameleon Engine çš„æ’ä»¶ç³»ç»Ÿæ¶æ„ï¼Œæ ¸å¿ƒç†å¿µæ˜¯**å®Œå…¨æ’ä»¶åŒ–**å’Œ**é«˜åº¦å¯æ‰©å±•**ã€‚

#### 1. æ ¸å¿ƒ API å±‚

å¼•æ“æä¾›äº†ä¸€ç»„ç¨³å®šçš„æ ¸å¿ƒ APIï¼Œä¾›æ’ä»¶è®¿é—®å’Œæ“ä½œï¼š

- **CPage**ï¼šé¡µé¢æ¨¡å‹ï¼Œç®¡ç†èŠ‚ç‚¹æ ‘ç»“æ„ï¼Œæä¾›èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥èƒ½åŠ›
- **Workbench**ï¼šå·¥ä½œå°å®¹å™¨ï¼Œç®¡ç†é¢æ¿ã€è§†å›¾çš„å¸ƒå±€å’Œäº¤äº’
- **Event Emitter**ï¼šäº‹ä»¶æ€»çº¿ï¼Œå®ç°æ¨¡å—é—´çš„æ¾è€¦åˆé€šä¿¡
- **Assets Manager**ï¼šèµ„æºåŒ…ç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†ç»„ä»¶èµ„æº
- **I18n**ï¼šå›½é™…åŒ–æ”¯æŒï¼Œæä¾›å¤šè¯­è¨€èƒ½åŠ›

#### 2. PluginManager - æ’ä»¶ç®¡ç†å™¨

PluginManager æ˜¯æ’ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£æ’ä»¶çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œæ‰©å±•èƒ½åŠ›ï¼š

**ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

- `add(plugin)`ï¼šæ³¨å†Œæ’ä»¶åˆ°ç³»ç»Ÿ
- `init(ctx)`ï¼šåˆå§‹åŒ–æ’ä»¶ï¼Œæ³¨å…¥ä¸Šä¸‹æ–‡
- `onPluginReadyOk(name)`ï¼šç­‰å¾…æ’ä»¶å°±ç»ªï¼Œæ”¯æŒå¼‚æ­¥ä¾èµ–
- `remove(name)`ï¼šå¸è½½æ’ä»¶ï¼Œæ¸…ç†èµ„æº

**æ‰©å±•èƒ½åŠ›**ï¼š

- `get(name)`ï¼šè·å–æ’ä»¶å®ä¾‹ï¼Œè®¿é—®æ’ä»¶æš´éœ²çš„ API
- `customPlugin(name, hook)`ï¼šå®šåˆ¶æ’ä»¶é…ç½®ï¼Œå®ç°æ’ä»¶çš„å¯æ›¿æ¢æ€§
- `export`ï¼šæ’ä»¶é€šè¿‡ export æš´éœ² APIï¼Œä¾›å…¶ä»–æ’ä»¶æˆ–å¤–éƒ¨è°ƒç”¨

**æ’ä»¶ä¸Šä¸‹æ–‡ (CPluginCtx)**ï¼š

- æ¯ä¸ªæ’ä»¶éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡å¯¹è±¡
- åŒ…å«å…¨å±€äº‹ä»¶ç³»ç»Ÿå’Œæ’ä»¶ç§æœ‰äº‹ä»¶ç³»ç»Ÿ
- å¯è®¿é—®æ‰€æœ‰æ ¸å¿ƒ API
- æ”¯æŒè‡ªå®šä¹‰é…ç½®å¯¹è±¡

#### 3. æ’ä»¶å®ä¾‹å±‚ - å¯æ‰©å±•/å¯æ›¿æ¢

**å†…ç½®æ’ä»¶**ï¼š

- æä¾›å¼€ç®±å³ç”¨çš„æ ¸å¿ƒåŠŸèƒ½
- å¯è¢«è‡ªå®šä¹‰æ’ä»¶å®Œå…¨æ›¿æ¢
- åŒ…æ‹¬ï¼šDesignerï¼ˆè®¾è®¡å™¨ï¼‰ã€Historyï¼ˆå†å²è®°å½•ï¼‰ã€RightPanelï¼ˆå±æ€§é¢æ¿ï¼‰ç­‰

**è‡ªå®šä¹‰æ’ä»¶**ï¼š

- å®Œå…¨è‡ªç”±çš„æ’ä»¶å¼€å‘
- å¯æ›¿æ¢ä»»ä½•å†…ç½®æ’ä»¶
- å¯æ‰©å±•æ–°åŠŸèƒ½
- ä¸å†…ç½®æ’ä»¶äº«æœ‰ç›¸åŒçš„ API è®¿é—®æƒé™

### æ’ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒç‰¹æ€§

#### å¯æ‰©å±•æ€§

- **æ— é™æ‰©å±•**ï¼šé€šè¿‡ `pluginManager.add()` å¯ä»¥æ·»åŠ ä»»æ„æ•°é‡çš„æ’ä»¶
- **å¹³ç­‰è®¿é—®**ï¼šè‡ªå®šä¹‰æ’ä»¶ä¸å†…ç½®æ’ä»¶æ‹¥æœ‰ç›¸åŒçš„æ ¸å¿ƒ API è®¿é—®æƒé™
- **ç‹¬ç«‹ä¸Šä¸‹æ–‡**ï¼šæ¯ä¸ªæ’ä»¶æ‹¥æœ‰ç‹¬ç«‹çš„é…ç½®å’Œäº‹ä»¶ç³»ç»Ÿ

#### å¯æ›¿æ¢æ€§

- **æ’ä»¶å®šåˆ¶**ï¼šé€šè¿‡ `customPlugin()` å¯ä»¥åœ¨æ’ä»¶åˆå§‹åŒ–å‰ä¿®æ”¹å…¶é…ç½®
- **å®Œå…¨æ›¿æ¢**ï¼šç§»é™¤å†…ç½®æ’ä»¶ï¼Œæ·»åŠ è‡ªå®šä¹‰æ’ä»¶å³å¯å®ç°åŠŸèƒ½æ›¿æ¢
- **çƒ­æ’æ‹”**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ å’Œç§»é™¤æ’ä»¶

#### æ¾è€¦åˆ

- **äº‹ä»¶é©±åŠ¨**ï¼šæ’ä»¶é—´é€šè¿‡äº‹ä»¶ç³»ç»Ÿé€šä¿¡ï¼Œé¿å…ç›´æ¥ä¾èµ–
- **API å¯¼å‡º**ï¼šæ’ä»¶é€šè¿‡ `export` æš´éœ²æ ‡å‡† APIï¼Œé™ä½è€¦åˆåº¦
- **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼šæ¯ä¸ªæ’ä»¶çš„çŠ¶æ€å’Œé…ç½®ç›¸äº’ç‹¬ç«‹

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px'}}}%%
flowchart LR
    Start([pluginManager.add]) --> CreateCtx

    subgraph Registration["æ³¨å†Œé˜¶æ®µ"]
        direction LR
        CreateCtx[åˆ›å»ºä¸Šä¸‹æ–‡<br/>CPluginCtx] --> CustomHook[è‡ªå®šä¹‰é’©å­<br/>customPlugin]
        CustomHook --> Init[plugin.init<br/>åˆå§‹åŒ–]
        Init --> Ready[pluginReadyOk<br/>å°±ç»ªé€šçŸ¥]
    end

    Ready --> Running

    subgraph RunningPhase["è¿è¡Œé˜¶æ®µ"]
        direction TB
        Running[æä¾›æœåŠ¡]
        Running -.get.-> Export[æš´éœ² API]
        Running -.emit.-> Events[å¤„ç†äº‹ä»¶]
        Running -.call.-> Interact[æ’ä»¶äº¤äº’]
    end

    Running --> Remove

    subgraph CleanupPhase["æ¸…ç†é˜¶æ®µ"]
        direction LR
        Remove[pluginManager.remove] --> Destroy[plugin.destroy<br/>æ¸…ç†]
        Destroy --> Release[é‡Šæ”¾èµ„æº]
    end

    Release --> End([å·²å¸è½½])

    style Start fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    style End fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    style Registration fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style RunningPhase fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style CleanupPhase fill:#fff3e0,stroke:#ef6c00,stroke-width:2px

    style CreateCtx fill:#bbdefb,stroke:#1976d2
    style CustomHook fill:#bbdefb,stroke:#1976d2
    style Init fill:#bbdefb,stroke:#1976d2
    style Ready fill:#bbdefb,stroke:#1976d2
    style Running fill:#ce93d8,stroke:#7b1fa2
    style Remove fill:#ffcc80,stroke:#f57c00
    style Destroy fill:#ffcc80,stroke:#f57c00
    style Release fill:#ffcc80,stroke:#f57c00
```

**ç”Ÿå‘½å‘¨æœŸè¯¦è§£**ï¼š

1. **æ³¨å†Œé˜¶æ®µ**ï¼ˆPluginRegistrationï¼‰

   - `pluginManager.add(plugin)`ï¼šæ³¨å†Œæ’ä»¶åˆ°ç³»ç»Ÿ
   - åˆ›å»ºæ’ä»¶ä¸Šä¸‹æ–‡ï¼ˆCPluginCtxï¼‰ï¼šåŒ…å«æ ¸å¿ƒ APIã€äº‹ä»¶ç³»ç»Ÿã€é…ç½®å¯¹è±¡
   - æ‰§è¡Œè‡ªå®šä¹‰é’©å­ï¼ˆcustomPluginHooksï¼‰ï¼šå¯åœ¨åˆå§‹åŒ–å‰ä¿®æ”¹æ’ä»¶é…ç½®
   - è°ƒç”¨ `plugin.init(ctx)`ï¼šæ‰§è¡Œæ’ä»¶åˆå§‹åŒ–é€»è¾‘
   - è§¦å‘ `pluginReadyOk()`ï¼šé€šçŸ¥ç³»ç»Ÿæ’ä»¶å·²å‡†å¤‡å°±ç»ª

2. **è¿è¡Œé˜¶æ®µ**ï¼ˆRunningï¼‰

   - æ’ä»¶å¯è¢«å…¶ä»–æ’ä»¶é€šè¿‡ `pluginManager.get(name)` è·å–
   - é€šè¿‡ `export` æš´éœ² API ä¾›å¤–éƒ¨è°ƒç”¨
   - ç›‘å¬å’Œå¤„ç†äº‹ä»¶
   - ä¸å…¶ä»–æ’ä»¶è¿›è¡Œäº¤äº’

3. **æ¸…ç†é˜¶æ®µ**ï¼ˆCleanupï¼‰
   - `pluginManager.remove(name)`ï¼šè§¦å‘å¸è½½æµç¨‹
   - è°ƒç”¨ `plugin.destroy(ctx)`ï¼šæ‰§è¡Œæ¸…ç†é€»è¾‘
   - æ³¨é”€äº‹ä»¶ç›‘å¬ï¼Œé¿å…å†…å­˜æ³„æ¼
   - æ¸…ç† UI ç»„ä»¶å’Œé‡Šæ”¾èµ„æº

## æ’ä»¶å®šä¹‰

æ’ä»¶å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿”å›æ’ä»¶å®šä¹‰çš„å‡½æ•°ï¼š

```typescript
export type PluginObj<C, E = any> = {
  /** æ’ä»¶åç§°ï¼ˆå¿…éœ€ï¼Œå¿…é¡»å”¯ä¸€ï¼‰ */
  name: string;
  /** æ’ä»¶é™æ€åç§°ï¼ˆå¯é€‰ï¼Œç”¨äºç±»å‹å®‰å…¨è®¿é—®ï¼‰ */
  PLUGIN_NAME?: string;
  /** åˆå§‹åŒ–æ–¹æ³•ï¼ˆå¿…éœ€ï¼‰ */
  init: (ctx: CPluginCtx<C>) => Promise<void>;
  /** é”€æ¯æ–¹æ³•ï¼ˆå¿…éœ€ï¼‰ */
  destroy: (ctx: CPluginCtx<C>) => Promise<void>;
  /** é‡è½½æ–¹æ³•ï¼ˆå¯é€‰ï¼‰ */
  reload?: (ctx: CPluginCtx<C>) => Promise<void>;
  /** å¯¼å‡º APIï¼ˆå¿…éœ€ï¼‰ */
  export: (ctx: CPluginCtx<C>) => E;
  /** å…ƒæ•°æ®ï¼ˆå¿…éœ€ï¼‰ */
  meta: {
    engine: {
      version: string;
    };
  };
};

export type CPlugin<C = any, E = any> = PluginObj<C, E> | ((ctx: CPluginCtx<C>) => PluginObj<C, E>);
```

### æ’ä»¶ä¸Šä¸‹æ–‡ (CPluginCtx)

æ’ä»¶ä¸Šä¸‹æ–‡æä¾›äº†è®¿é—®å¼•æ“æ ¸å¿ƒåŠŸèƒ½çš„èƒ½åŠ›ï¼š

```typescript
type CPluginCtx<C = any> = {
  name?: string; // æ’ä»¶åç§°
  globalEmitter: Emitter<any>; // å…¨å±€äº‹ä»¶å‘å°„å™¨
  emitter: Emitter<any>; // æ’ä»¶ç§æœ‰äº‹ä»¶å‘å°„å™¨
  config: C; // æ’ä»¶é…ç½®å¯¹è±¡
  getWorkbench: () => Workbench; // è·å–å·¥ä½œå°å®ä¾‹
  pluginManager: PluginManager; // æ’ä»¶ç®¡ç†å™¨
  pageModel: CPage; // é¡µé¢æ¨¡å‹
  i18n: CustomI18n; // å›½é™…åŒ–å¯¹è±¡
  assetsPackageListManager: AssetsPackageListManager; // èµ„æºåŒ…ç®¡ç†å™¨
  engine: Engine; // å¼•æ“å®ä¾‹
  pluginReadyOk: () => void; // é€šçŸ¥æ’ä»¶å·²å‡†å¤‡å¥½
};
```

## å¿«é€Ÿå¼€å§‹

### åˆ›å»ºä¸€ä¸ªç®€å•çš„æ’ä»¶

```typescript
import { CPlugin } from '@chamn/engine';

const PLUGIN_NAME = 'HelloPlugin' as const;

export const HelloPlugin: CPlugin = (ctx) => {
  return {
    name: PLUGIN_NAME,
    PLUGIN_NAME,

    async init(ctx) {
      console.log('Hello Plugin åˆå§‹åŒ–ï¼');

      // æ·»åŠ å·¦ä¾§é¢æ¿
      const workbench = ctx.getWorkbench();
      workbench.addLeftPanel({
        name: PLUGIN_NAME,
        title: 'Hello',
        icon: <span>ğŸ‘‹</span>,
        view: <div>Hello World!</div>,
      });

      // é€šçŸ¥æ’ä»¶å·²å‡†å¤‡å¥½ï¼ˆé‡è¦ï¼ï¼‰
      ctx.pluginReadyOk();
    },

    async destroy(ctx) {
      console.log('Hello Plugin é”€æ¯');
    },

    export: (ctx) => {
      return {
        sayHello() {
          console.log('Hello from plugin!');
        },
      };
    },

    meta: {
      engine: {
        version: '1.0.0',
      },
    },
  };
};

// æ·»åŠ é™æ€å±æ€§ï¼ˆæ¨èï¼‰
HelloPlugin.PLUGIN_NAME = PLUGIN_NAME;
```

### ä½¿ç”¨æ’ä»¶

```tsx
import { Engine, plugins } from '@chamn/engine';
import { HelloPlugin } from './HelloPlugin';

const { DEFAULT_PLUGIN_LIST } = plugins;

function App() {
  const onReady = async (ctx) => {
    // è·å–æ’ä»¶å®ä¾‹
    const helloPlugin = await ctx.pluginManager.get('HelloPlugin');

    // è°ƒç”¨æ’ä»¶æ–¹æ³•
    helloPlugin?.export.sayHello();
  };

  return (
    <Engine
      plugins={[...DEFAULT_PLUGIN_LIST, HelloPlugin]}
      schema={pageSchema}
      material={materials}
      onReady={onReady}
    />
  );
}
```

## å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹ 1: å†å²è®°å½•æ’ä»¶

å®Œæ•´çš„å†å²è®°å½•æ’ä»¶å®ç°ï¼Œæ”¯æŒæ’¤é”€/é‡åšåŠŸèƒ½ï¼š

```typescript
import { waitReactUpdate } from '@/utils';
import { CPageDataType } from '@chamn/model';
import { cloneDeep, debounce } from 'lodash-es';
import { CPlugin, CPluginCtx } from '@chamn/engine';

const PLUGIN_NAME = 'History' as const;

export type HistoryExport = {
  addStep: () => void;
  reset: () => Promise<void>;
  preStep: () => void;
  nextStep: () => void;
  canGoPreStep: () => boolean;
  canGoNextStep: () => boolean;
};

export const HistoryPlugin: CPlugin<any, HistoryExport> = (ctx) => {
  const CTX: CPluginCtx | null = ctx;
  const dataStore = {
    historyRecords: [] as CPageDataType[],
    currentStepIndex: 0,
  };

  let originalPageRecord: CPageDataType | null = null;
  const pageSchema = ctx.pageModel.export();
  originalPageRecord = pageSchema;
  dataStore.historyRecords.push(pageSchema);

  const loadPage = async (page: CPageDataType) => {
    if (!CTX) {
      return;
    }
    CTX.pageModel.reloadPage(page);
    await waitReactUpdate();
  };

  const resObj = {
    addStep: () => {
      const { currentStepIndex, historyRecords } = dataStore;
      const newPage = ctx.pageModel.export();
      if (currentStepIndex !== historyRecords.length - 1) {
        dataStore.historyRecords = historyRecords.slice(0, currentStepIndex + 1);
      }
      dataStore.historyRecords.push(newPage);
      dataStore.currentStepIndex = historyRecords.length - 1;
    },
    reset: async () => {
      const ctx = CTX;
      if (!ctx) {
        console.warn('plugin ctx is null, pls check it');
        return;
      }
      if (!originalPageRecord) {
        return;
      }
      dataStore.historyRecords = [];
      loadPage(originalPageRecord);
    },
    preStep: () => {
      const { currentStepIndex, historyRecords } = dataStore;
      if (!resObj.canGoPreStep()) {
        return;
      }
      const newIndex = currentStepIndex - 1;
      dataStore.currentStepIndex = newIndex;
      const page = cloneDeep(historyRecords[newIndex]);
      loadPage(page);
    },
    nextStep: () => {
      if (!resObj.canGoNextStep()) {
        return;
      }
      const { currentStepIndex, historyRecords } = dataStore;
      const newIndex = currentStepIndex + 1;
      dataStore.currentStepIndex = newIndex;
      const page = cloneDeep(historyRecords[newIndex]);
      return loadPage(page);
    },
    canGoPreStep: () => {
      const { currentStepIndex } = dataStore;
      if (currentStepIndex <= 0) {
        return false;
      }
      return true;
    },
    canGoNextStep: () => {
      const { currentStepIndex, historyRecords } = dataStore;
      if (currentStepIndex >= historyRecords.length - 1) {
        return false;
      }
      return true;
    },
  };

  // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è®°å½•
  const debounceAddStep = debounce(() => {
    resObj.addStep();
  }, 500);

  return {
    name: PLUGIN_NAME,
    PLUGIN_NAME,
    async init(ctx) {
      // ç›‘å¬èŠ‚ç‚¹å˜åŒ–
      ctx.pageModel.emitter.on('onNodeChange', () => {
        debounceAddStep();
      });

      // ç›‘å¬é¡µé¢å˜åŒ–
      ctx.pageModel.emitter.on('onPageChange', () => {
        resObj.addStep();
      });

      // !!! å¿…é¡»è°ƒç”¨ï¼Œé€šçŸ¥ engineï¼Œæ’ä»¶åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥è¢«æ¶ˆè´¹
      ctx.pluginReadyOk();
    },
    async destroy(ctx) {
      console.log('destroy', ctx);
    },
    // æä¾›ç»™å…¶ä»–æ’ä»¶æˆ–è€…å¤–éƒ¨ä½¿ç”¨çš„æ–¹æ³•
    export: () => {
      return resObj;
    },
    // æ’ä»¶å…ƒä¿¡æ¯ï¼Œå¼•æ“çš„æœ€ä½ç‰ˆæœ¬è¦æ±‚
    meta: {
      engine: {
        version: '1.0.0',
      },
    },
  };
};

HistoryPlugin.PLUGIN_NAME = PLUGIN_NAME;
```

### ç¤ºä¾‹ 2: è‡ªå®šä¹‰é¢æ¿æ’ä»¶

```typescript
import React, { useState } from 'react';
import { CPlugin } from '@chamn/engine';
import { Button, Input } from 'antd';

const PLUGIN_NAME = 'CustomPanel' as const;

// é¢æ¿è§†å›¾ç»„ä»¶
const CustomPanelView: React.FC<{ pluginCtx: any }> = ({ pluginCtx }) => {
  const [text, setText] = useState('');

  return (
    <div style={{ padding: '20px' }}>
      <h3>è‡ªå®šä¹‰é¢æ¿</h3>
      <Input placeholder="è¾“å…¥æ–‡æœ¬" value={text} onChange={(e) => setText(e.target.value)} />
      <Button
        style={{ marginTop: '10px' }}
        onClick={() => {
          console.log('è¾“å…¥çš„æ–‡æœ¬:', text);
        }}
      >
        æäº¤
      </Button>
    </div>
  );
};

export const CustomPanelPlugin: CPlugin = (ctx) => {
  return {
    name: PLUGIN_NAME,
    PLUGIN_NAME,

    async init(ctx) {
      const workbench = ctx.getWorkbench();

      // æ·»åŠ å·¦ä¾§é¢æ¿
      workbench.addLeftPanel({
        name: PLUGIN_NAME,
        title: 'è‡ªå®šä¹‰é¢æ¿',
        icon: <span>ğŸ“</span>,
        view: <CustomPanelView pluginCtx={ctx} />,
      });

      ctx.pluginReadyOk();
    },

    async destroy(ctx) {
      console.log('æ¸…ç†æ’ä»¶');
    },

    export: (ctx) => ({}),

    meta: {
      engine: { version: '1.0.0' },
    },
  };
};

CustomPanelPlugin.PLUGIN_NAME = PLUGIN_NAME;
```

### ç¤ºä¾‹ 3: è‡ªå®šä¹‰å·¥å…·æ æ’ä»¶

```typescript
import React from 'react';
import { CPlugin } from '@chamn/engine';
import { Button, Space } from 'antd';

const PLUGIN_NAME = 'CustomToolbar' as const;

export const CustomToolbarPlugin: CPlugin = (ctx) => {
  return {
    name: PLUGIN_NAME,
    PLUGIN_NAME,

    async init(ctx) {
      const workbench = ctx.getWorkbench();
      const engine = ctx.engine;

      // è‡ªå®šä¹‰é¡¶éƒ¨å·¥å…·æ 
      workbench.replaceTopBarView(
        <div
          style={{
            width: '100%',
            height: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '0 20px',
          }}
        >
          <div style={{ fontSize: '18px', fontWeight: 'bold' }}>æˆ‘çš„ç¼–è¾‘å™¨</div>

          <Space>
            <Button onClick={() => engine.preview()}>é¢„è§ˆ</Button>
            <Button onClick={() => engine.existPreview()}>ç¼–è¾‘</Button>
            <Button onClick={() => engine.refresh()}>åˆ·æ–°</Button>
            <Button
              type="primary"
              onClick={() => {
                const pageData = engine.pageModel.export();
                localStorage.setItem('page', JSON.stringify(pageData));
              }}
            >
              ä¿å­˜
            </Button>
          </Space>
        </div>
      );

      ctx.pluginReadyOk();
    },

    async destroy(ctx) {},
    export: (ctx) => ({}),
    meta: { engine: { version: '1.0.0' } },
  };
};

CustomToolbarPlugin.PLUGIN_NAME = PLUGIN_NAME;
```

## åŠ è½½æ’ä»¶

```tsx
import { Engine, EnginContext, plugins } from '@chamn/engine';
import { HistoryPlugin } from './HistoryPlugin';
import { CustomPanelPlugin } from './CustomPanelPlugin';

const { DEFAULT_PLUGIN_LIST } = plugins;

export const App = () => {
  const onReady = useCallback(async (ctx: EnginContext) => {
    // ç­‰å¾…æ’ä»¶å‡†å¤‡å®Œæˆ
    const designer = await ctx.pluginManager.onPluginReadyOk('Designer');
    const history = await ctx.pluginManager.onPluginReadyOk('History');

    // è·å–å·¥ä½œå°
    const workbench = ctx.engine.getWorkbench();

    // ä½¿ç”¨æ’ä»¶å¯¼å‡ºçš„æ–¹æ³•
    history?.export.preStep();
  }, []);

  return (
    <Engine
      // åŠ è½½æ’ä»¶
      plugins={[...DEFAULT_PLUGIN_LIST, HistoryPlugin, CustomPanelPlugin]}
      schema={pageSchema}
      material={materials}
      onReady={onReady}
    />
  );
};
```

## æ’ä»¶é…ç½®

é€šè¿‡ `beforePluginRun` è‡ªå®šä¹‰æ’ä»¶é…ç½®ï¼š

```tsx
import { Engine, plugins } from '@chamn/engine';

const beforePluginRun = ({ pluginManager }) => {
  // è‡ªå®šä¹‰æ’ä»¶é…ç½®
  pluginManager.customPlugin('MyPlugin', (pluginInstance) => {
    // ä¿®æ”¹æ’ä»¶é…ç½®
    pluginInstance.ctx.config.customOption = 'value';

    return pluginInstance;
  });
};

<Engine
  beforePluginRun={beforePluginRun}
  plugins={plugins}
  // ...
/>;
```

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ TypeScript

```typescript
import { CPlugin, CPluginCtx } from '@chamn/engine';

// å®šä¹‰é…ç½®ç±»å‹
type MyPluginConfig = {
  enabled: boolean;
  option1: string;
};

// å®šä¹‰å¯¼å‡ºç±»å‹
type MyPluginExport = {
  doSomething: () => void;
};

// ä½¿ç”¨æ³›å‹
export const MyPlugin: CPlugin<MyPluginConfig, MyPluginExport> = (ctx) => {
  return {
    name: 'MyPlugin',

    async init(ctx) {
      // ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®
      const enabled = ctx.config.enabled;

      ctx.pluginReadyOk();
    },

    async destroy(ctx) {},

    export: (ctx) => {
      return {
        doSomething() {
          console.log('Do something');
        },
      };
    },

    meta: { engine: { version: '1.0.0' } },
  };
};
```

### 2. å‘½åè§„èŒƒ

- æ’ä»¶å‘½åç»Ÿä¸€é‡‡ç”¨ `PascalCase`ï¼Œå¦‚ `MyPlugin`
- æ’ä»¶åç§°å¸¸é‡ä½¿ç”¨ `PLUGIN_NAME`
- å¯¼å‡ºçš„æ’ä»¶å¯¹è±¡æ·»åŠ é™æ€å±æ€§ `PLUGIN_NAME`

### 3. é”™è¯¯å¤„ç†

```typescript
export const SafePlugin: CPlugin = (ctx) => {
  return {
    name: 'SafePlugin',

    async init(ctx) {
      try {
        // å¯èƒ½å‡ºé”™çš„æ“ä½œ
        const data = await fetchData();

        // éªŒè¯ä¾èµ–
        const workbench = ctx.getWorkbench();
        if (!workbench) {
          throw new Error('å·¥ä½œå°æœªåˆå§‹åŒ–');
        }

        ctx.pluginReadyOk();
      } catch (error) {
        console.error('æ’ä»¶åˆå§‹åŒ–å¤±è´¥:', error);
        ctx.pluginReadyOk(); // å³ä½¿å¤±è´¥ä¹Ÿé€šçŸ¥
      }
    },

    async destroy(ctx) {},
    export: (ctx) => ({}),
    meta: { engine: { version: '1.0.0' } },
  };
};
```

### 4. å†…å­˜ç®¡ç†

```typescript
export const MemoryAwarePlugin: CPlugin = (ctx) => {
  const disposables: (() => void)[] = [];

  return {
    name: 'MemoryAwarePlugin',

    async init(ctx) {
      // ç›‘å¬äº‹ä»¶
      const handler = () => {
        /* ... */
      };
      ctx.globalEmitter.on('event', handler);

      // è®°å½•æ¸…ç†å‡½æ•°
      disposables.push(() => {
        ctx.globalEmitter.off('event', handler);
      });

      ctx.pluginReadyOk();
    },

    async destroy(ctx) {
      // æ‰§è¡Œæ‰€æœ‰æ¸…ç†å‡½æ•°
      disposables.forEach((dispose) => dispose());
      disposables.length = 0;
    },

    export: (ctx) => ({}),
    meta: { engine: { version: '1.0.0' } },
  };
};
```

## å¸¸è§é—®é¢˜

### Q: æ’ä»¶ä½•æ—¶åˆå§‹åŒ–ï¼Ÿ

A: æ’ä»¶åœ¨ Engine ç»„ä»¶ `componentDidMount` æ—¶åˆå§‹åŒ–ï¼ŒæŒ‰ç…§æ’ä»¶åˆ—è¡¨çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ `init` æ–¹æ³•ã€‚

### Q: å¦‚ä½•ç¡®ä¿æ’ä»¶åˆå§‹åŒ–å®Œæˆï¼Ÿ

A: ä½¿ç”¨ `ctx.pluginReadyOk()` é€šçŸ¥æ’ä»¶ç®¡ç†å™¨æ’ä»¶å·²å‡†å¤‡å¥½ã€‚å…¶ä»–æ’ä»¶å¯ä»¥é€šè¿‡ `ctx.pluginManager.onPluginReadyOk('PluginName')` ç­‰å¾…ã€‚

### Q: æ’ä»¶å¯ä»¥è®¿é—®å…¶ä»–æ’ä»¶å—ï¼Ÿ

A: å¯ä»¥ã€‚ä½¿ç”¨ `ctx.pluginManager.get('PluginName')` è·å–å…¶ä»–æ’ä»¶å®ä¾‹ã€‚

## å‚è€ƒèµ„æº

- [å†…ç½®æ’ä»¶åˆ—è¡¨](../innder-plugin-list/) - æŸ¥çœ‹æ‰€æœ‰å†…ç½®æ’ä»¶
- [å†…ç½®æ’ä»¶ä½¿ç”¨æŒ‡å—](../built-in-plugins-usage/) - å­¦ä¹ å†…ç½®æ’ä»¶çš„ç”¨æ³•
- [Engine API](../../engine/api/) - äº†è§£ Engine çš„ API
- [ç¤ºä¾‹é¡¹ç›®](https://github.com/ByteCrazy/chameleon-demo) - æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹
